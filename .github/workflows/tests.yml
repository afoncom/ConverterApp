name: Unit Tests

on:
workflow_dispatch:
pull_request:
branches: [ main, develop ]
push:
branches: [ main, develop ]

jobs:
test:
name: Run Unit Tests
runs-on: macos-latest

```
steps:
  - name: Checkout code
    uses: actions/checkout@v4

  - name: Select Xcode version
    uses: maxim-lobanov/setup-xcode@v1
    with:
      xcode-version: latest-stable

  - name: Install Homebrew dependencies
    run: |
      brew install tuist
      brew install swiftgen

  - name: Generate Xcode project with Tuist
    run: tuist generate

  - name: Create SwiftGen output folder
    run: mkdir -p CurrencyConverter/Sources/Generated

  - name: Run SwiftGen
    run: |
      swiftgen config lint --config swiftgen.yml
      swiftgen config run --config swiftgen.yml

  - name: List available simulators
    run: xcrun simctl list devices

  - name: Select first available iPhone simulator
    id: select_sim
    run: |
      UDID=$(xcrun simctl list devices available | grep "iPhone" | head -n1 | sed -E 's/.*\(([A-F0-9-]+)\).*/\1/')
      echo "Selected UDID: $UDID"
      echo "UDID=$UDID" >> $GITHUB_OUTPUT

  - name: Boot simulator (no error if already booted)
    run: xcrun simctl boot ${{ steps.select_sim.outputs.UDID }} || true

  - name: Run Unit Tests
    run: |
      set -o pipefail && xcodebuild test \
        -workspace CurrencyConverter.xcworkspace \
        -scheme CurrencyConverter \
        -destination "id=${{ steps.select_sim.outputs.UDID }}" \
        -enableCodeCoverage YES \
        | tee xcodebuild.log

  - name: Upload logs if failed
    if: failure()
    uses: actions/upload-artifact@v4
    with:
      name: xcodebuild-log
      path: xcodebuild.log
```
